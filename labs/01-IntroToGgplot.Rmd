---
title: "Creating Graphs with ggplot2"
author: "Lab 1, Fall 2016"
output:
  html_document:
    fig_height: 2
    fig_width: 5
  word_document:
    fig_height: 2
    fig_width: 5
---

### 1. Introduction
It is often necessary to create graphics to effectively communicate key patterns within a dataset. While many software packages allow the user to make basic plots, it can be challenging to create plots that are customized to address a specific idea. While there are numerous ways to create graphs, this tutorial will focus on the R package `ggplot2`, created by Hadley Wickham.


In this lab, we will focus on building plots in layers using the `ggplot2` package. This approach uses a particular grammar inspired by Leland Wilkinson's landmark book, *The Grammar of Graphics*, that focused on thinking about, reasoning with and communicating with graphics. It enables layering of independent components to create custom graphics for tidy data sets.

To begin, load the `ggplot2` package using the following command
```{r message = FALSE}
library(ggplot2)
library(mosaic)
```

If you have not yet installed the package, you can do so with the following command

```{r eval=FALSE}
install.packages("ggplot2")
```


**Data**: In this tutorial, we will use the  [AmesHousing](http://www.amstat.org/publications/jse/v19n3/decock.pdf) data set, which provides information on the sales of individual residential properties in Ames, Iowa from 2006 to 2010. The data set contains 2930 observations, and a large number of explanatory variables involved in assessing home values. A full description of this dataset can be found [here](http://www.amstat.org/publications/jse/v19n3/Decock/DataDocumentation.txt).

If you have saved the data file in the data folder of your RStudio project, then you can load it using the following command. Alternatively, you can use "Import Dataset" button in the Enrivonment tab.

```{r}
AmesHousing <- read.csv("data/AmesHousing.csv")
# str(AmesHousing)
```

### 2. Building your first plot

To see how plots are constructed, let's first create a histogram of the sales price (`SalePrice`) of homes in Ames, IA. To do this, we will use the `ggplot` function which expects at a bare minimal as arguments:

* the data frame where the variables exist (the `data` argument) and
* the names of the variables to be plotted (the `mapping` argument).

The names of the variables will be entered into the aes function as arguments where aes stands for "aesthetics".

With that in mind, we start by creating the base layer, or the backdrop on which we will layer the elements of our histogram.

```{r}
ggplot(data = AmesHousing, mapping = aes(x = SalePrice))
```

We next proceed by adding a layer---hence, the use of the + symbol---to the plot to produce a histogram.

Note: You are encouraged to enter **Return** on your keyboard after entering the `+`. As we add more and more elements, it will be nice to keep them indented as you see below. Note that this will not work if you begin the line with the `+`.

```{r}
ggplot(data = AmesHousing, mapping = aes(x = SalePrice)) +
  geom_histogram()
```

Here, we are warned that the histogram was been drawn with 30 bins, a rather arbitrary choice. We can customize our histogram by adding a `binwidth` argument to the `geom_histogram` command:

```{r}
ggplot(data = AmesHousing, mapping = aes(x = SalePrice)) +
  geom_histogram(binwidth=10000)
```

We can also add some color to the plot by invoking the fill and color arguments.

```{r}
ggplot(data = AmesHousing, mapping = aes(x = SalePrice)) +
  geom_histogram(binwidth=10000, fill = "steelblue2", color = "black")
```

Currently, the x-axis label does not contain units. To change the axis labels we add a layer to our plot

```{r}
ggplot(data = AmesHousing, mapping = aes(x = SalePrice)) +
  geom_histogram(binwidth=10000, fill = "steelblue2", color = "black") +
  labs(x = "Sale Price (in dollars)")
```

Note that we can also tweak the y-axis label with the addition of a `y` argument in the `labs` function.

Finally, we can easily add a title to our plot with the addition of another layer

```{r}
ggplot(data = AmesHousing, mapping = aes(x = SalePrice)) +
  geom_histogram(binwidth=10000, fill = "steelblue2", color = "black") +
  labs(x = "Sale Price (in dollars)") +
  ggtitle("Sales Prices of Homes in Ames, IA")
```


Throughout the remainder of this lab we will explore how to create and customize the basic plot types:

* histograms,
* bar charts,
* density plots,
* scatterplots,
*  and side-by-side plots.

### 3. Building basic univariate plots

### 4. Building bivariate plots

### 5. Building side-by-side plots

**Questions:**  

6) Modify the code for histogram above so that the `aes` is not within the `geom`. However the resulting graph should look identical to the one above.
7) Create a scatterplot using `ggplot` with **Fireplaces** as the x-axis and **SalePrice** as the y-axis.


### 3. Customizing graphics

In the following code, we layer additional components onto the two graphs shown above.

```{r}
ggplot(data=AmesHousing) +                         
      geom_histogram(mapping = aes(SalePrice/100000), 
          breaks=seq(0, 7, by = 1), col="red", fill="lightblue") + 
      geom_density(mapping = aes(x=SalePrice/100000, y = (..count..)))  +   
      labs(title="Figure 9: Housing Prices in Ames, Iowa (in $100,000)", 
          x="Sale Price of Individual Homes")   
```

**Remarks:**

* The histogram geom transforms the SalePrice, modifies the bin size and changes the color.
* `geom_density` overlays a density curve on top of the histogram.
* Typically density curves and histrograms have very different scales, here we use `y = (..count..)` to modify the density. Alternatively, we could specify `aes(x = SalePrice/100000, y = (..density..))` in the histogram geom.
* The labs() command adds a title and an x-axis label. A y-axis label can also be added by using `y = " ".


In the code below we create three scatterplots of the log of the above ground living area by the log of sales price

```{r}
ggplot(data=AmesHousing, aes(x=log(Gr.Liv.Area), y=log(SalePrice)) ) +      
  geom_point(shape = 3, color = "darkgreen") +                                     
  geom_smooth(method=lm,  color="green") +                  
  labs(title="Figure 10: Housing Prices in Ames, Iowa")

 
ggplot(data=AmesHousing) + 
  geom_point(aes(x=log(Gr.Liv.Area), y=log(SalePrice), color=Kitchen.Qual),shape=2, size=2) + 
  geom_smooth(aes(x=log(Gr.Liv.Area), y=log(SalePrice), color=Kitchen.Qual), 
          method=loess, size=1) +                        
  labs(title="Figure 11: Housing Prices in Ames, Iowa") 

ggplot(data=AmesHousing) +
  geom_point(mapping = aes(x=log(Gr.Liv.Area), y=log(SalePrice), color=Kitchen.Qual)) +
  geom_smooth(mapping = aes(x=log(Gr.Liv.Area), y=log(SalePrice), color=Kitchen.Qual), 
      method=lm, se=FALSE, fullrange=TRUE) +                             
  facet_grid(. ~ Fireplaces) +                      
  labs(title="Figure 12: Housing Prices in Ames, Iowa")
```

**Remarks:**

* `geom_point` is used to create a scatterplot. As shown in Figure 10, multiple shapes can be used as points. The [Data Visualization Cheat Sheet](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf) lists several shape options`
* `geom_smooth` adds a fitted line through the data.  
    + `method=lm` specifies a linear regression line. `method=loess` in the creates a smooth fit curve.
    + `se=FALSE` removes the shaded confidence regions around each line. 
    + `fullrange=TRUE` extends all regression lines to the same length
*  `facet_grid` and `facet_wrap` commands are used to create multiple plots. In Figure 12, we have created separate scatterplots based upon the number of fireplaces.
*  When assigning fixed characteristics, (such as `color`, `shape` or `size`), the commands occur outside the `aes`, as in Figure 10, `color="green"`. When characteristics are dependent on the data, the command should occur within the `aes`, such as in Figure 11 `color=Kitchen.Qual`.

plot.title and axis.title are "theme elements." (Notice in the below table that you can modify the x and y axes individually.)

In the above examples, only a few `geoms` are listed. The [ggplot2 website](http://docs.ggplot2.org/current/) lists each `geom` and gives detailed examples of how they are used. 


**Questions:**  

8) Create a histogram of the above ground living area, `Gr.Liv.Area`.
9) Create a scatterplot using `Year.Built` as the explanatory variable and `SalePrice` as the response variable. Include a regression line, a title, and labels for the x and y axes.
10) Modify the scatterplot in Question 9) so that there is still only one regression line, but the points are colored by the overall condition of the home, `Overall.Cond`. 


```{r eval=FALSE, echo=FALSE}
# SAMPLE  SOLUTIONS
# A histogram of above ground living area 
ggplot(data=AmesHousing) +                         
  geom_histogram(mapping = aes(Gr.Liv.Area))

# Create a scatterplot of above ground living area by sales price
ggplot(data=AmesHousing, aes(x=Year.Built, y=SalePrice)) +      
  geom_point() +
  geom_smooth(method=lm) +                  
  labs(title="Housing Prices in Ames, Iowa", x="Year Built", y = "Sale Price")

# Create scatterplot and regression lines colored by the kitchen quality rating
ggplot(data=AmesHousing, aes(x=Year.Built, y=SalePrice, color=Overall.Qual)) + 
  geom_point() +                               
  geom_smooth(method=lm, se=FALSE) +                        
  labs(title="Housing Prices in Ames, Iowa", x="Year Built", y = "Sale Price")

```


### 5. Additional Considerations with R graphics

**Influence of data types on graphics:** If you use the `str` command after reading data into R, you will notice that each variable is assigned one of the following `types`: Character, Numeric (real numbers), Integer, Complex, or Logical (TRUE/FALSE). In particular, the variable **Fireplaces** in considered an integer. In the code below we try to `color` and `fill` a density graph by an integer value. Notice that the color and fill commands appear to be ignored in the graph.
```{r}
# str(AmesHousing)
ggplot(data=AmesHousing) +                   
  geom_density(aes(SalePrice, color = Fireplaces,  fill = Fireplaces))
```

In the following code, we use the `dplyr` package to modify the AmesHousing data; we first restrict the dataset to only houses with less than three fireplaces and then create a new variable, called **Fireplace2**. The `as.factor` command creates a **factor**, wich is a variable that contains a set of numeric codes with character-valued levels. Notice that the `color` and `fill` command now work properly. 

```{r}
# Create a new data frame with only houses with less than 3 fireplaces
AmesHousing2 <- filter(AmesHousing, Fireplaces < 3)
# Create a new variable called Fireplace2
AmesHousing2 <-mutate(AmesHousing2,Fireplace2=as.factor(Fireplaces))
#str(AmesHousing2)

ggplot(data=AmesHousing2) +                 
  geom_density(aes(SalePrice, color = Fireplace2,  fill = Fireplace2), alpha = 0.2)
```

**Customizing graphs:** In addition to using a **data frame**, **geoms**, and **aes**, several additional components can be added to customize each graph, such as: **stats**, **scales**, **themes**, **positions**, **coordinate systems**, **labels**, and **legends**. We will not discuss all of these components here, but the materials in the references section provide detailed explanations. In the code below we provide a few examples on how to customize graphs.

```{r warning =FALSE}
ggplot(AmesHousing2, aes(x = Fireplace2, y = SalePrice, color = Paved.Drive)) +
  geom_boxplot(position = position_dodge(width = 1)) +
  coord_flip()+ 
  labs(title="Housing Prices in Ames, Iowa") +
  theme(plot.title = element_text(family = "Trebuchet MS", color = "blue", face="bold", size=12, hjust=0))
```

**Remarks:**

* `position` is used to address geoms that would take the same space on a graph. In the above boxplot, `position_dodge(width = 1)` adds a space between each box. For scatterplots, `position = position_jitter()` puts spaces between overlapping points.
* `theme` is used to change the style of a graph, but does not change the data or geoms. The above code is used to modify only the title in a boxplot. A better approach for beginners is to choose among themes that were created to customize the overall graph. Common examples are `theme_bw()`, `theme_classic()`, `theme_grey()`, and `theme_minimal()`. You can also install the `ggthemes` package for many more options.


**Questions:**  

13) In the density plot above, explain what the `color`, `fill`, and `alpha` commands are used for. Hint: try running the code with and without these commands or use the [Data Visualization Cheat Sheet]( https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf). 

14) In the boxplot, what is done by the code `coord_flip()`?

15) Create a new boxplot, similar to the one above, but use `theme_bw()` instead of the given theme command. Explain how the graph changes.

16) Use the tab completion feature in RStudio (type theme and hit the `Tab` key to see various options) to determine what theme is the default for most graphs in ggplot.


### 7. On your own

In order to complete this activity, you will need to use the `dplyr` package to manipulate the dataset before making any graphics.

* Restrict the `AmesHousing` data to only sales under normal conditions. In other words, `Condition.1 == Norm`
* Create a new variable called `TotalSqFt = GR.Liv.Area  +  Total.Bsmt.SF` and remove any homes with more than 3000 total square feet.
* Create a new variable, where `No` indicates no fireplaces in the home and `Yes` indicates at least one fireplace in the home.
* With this modified data file, create a graphic involving no more than three explanatory variables that best portrays how to predict sales price. For example, Figure 12 uses a linear model of kitchen quality, above ground square footage, and number of fireplaces to predict sale price.

### Additional resources
- https://www.youtube.com/watch?v=HeqHMM4ziXA and https://www.youtube.com/watch?v=n8kYa9vu1l8: Two introductory videos on ggplot2 by Roger Peng.

- https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf: Data Visualization with ggplot2 Cheat Sheet 

-  http://docs.ggplot2.org/current/:    A well-documented list of ggplot2 components with descriptions 

-  http://www.statmethods.net/advgraphs/ggplot2.html:   Quick-R introduction to graphics

- http://cran.r-project.org/web/packages/ggplot2/ggplot2.pdf: Formal documentation of the ggplot2 package

- http://www.ceb-institute.org/bbs/wp-content/uploads/2011/09/handout_ggplot2.pdf: A tutorial on ggplot2 by Hadley Wickham.

- http://stackoverflow.com/tags/ggplot2: Stackoverflow, an online community to share information. 

- http://www.cookbook-r.com/Graphs/: R Graphics Cookbook, a text by Winston Chang
http://ggplot2.org/book/ : Sample chapters of Hadley Wickhams text,  ggplot2: Elegant Graphics for Data Analysis





